---
title: "Topic 1: Project organisation"
author: "Emma Rand"
output:
  html_document:
    toc: true
    depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: flatly
  word_document: default
---


![](../pics/58M.png)
[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.5442490.svg)](https://doi.org/10.5281/zenodo.5442490)

<!-- note for 2022 update, switch chaffinch example to subspecies -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

```{r include=FALSE}
library(RefManageR)
```


```{r, load-refs, include=FALSE, cache=FALSE}
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "authoryear",
           style = "markdown",
           hyperlink = FALSE,
           dashed = FALSE,
           longnamesfirst = FALSE,
           max.names = 2)
myBib <- ReadBib("../refs.bib", check = FALSE)
```

# Week Overview

## Aim
The aim of this week is to introduce you to RStudio Projects and good practices for organising work. 
## Objectives
By the end of this week the successful student should be able to:
-  Use an RStudio project with structured directories and documentation to organise their work
-  develop a convention for naming files and directories which is machine and human readable

# Task 1 New RStudio Project

This exercise allows you go through the new RStudio Project with the **`usethis`** `r Cite(myBib, "usethis")` workflow. 

The data in [chaff.txt](../data-raw/chaff.txt) are the masses of male and female chaffinches. They are organised as two columns, `males` and `females`, a format which is not ideal. Your task is to organise an analysis of these data in an RStudio Project. The analysis will include data import, reformatting, writing reformatted data to file, summarising, significance testing and plotting.

`r emo::ji("clapper")` First check your working directory with `getwd()` and determine what path you need to create the RStudio Project in a place that suits you.

`r emo::ji("clapper")` Create the RStudio Project with:

```{r eval=FALSE}
usethis::create_project("chaffinches")
```
   
`r emo::ji("clapper")` Add a README with:

```{r eval=FALSE}
usethis::use_readme_md()
```

`r emo::ji("clapper")` Add some text to the README about the data and analysis. You can continue to edit this as you work.

`r emo::ji("clapper")` Add a LICENSE with:

```{r eval=FALSE}
usethis::use_ccby_license()
```

`r emo::ji("clapper")` Add directories to structure the analysis - you may wish to revise this as you work. I suggest adding `data-raw` and `data-processed`

`r emo::ji("clapper")` Save a copy of [chaff.txt](../data-raw/chaff.txt) to `data-raw`

`r emo::ji("clapper")` Make a script called `01-import.R`. There is a **`usethis`** helper function for that purpose if you wish:
```{r eval=FALSE}
usethis::use_r("01-import")
```

`usethis::use_r()` helpfully adds the R extension and creates the file in the `R/` directory

We will now add code to import and reformat the data as 'tidy' `r Cite(myBib, "Wickham2014-nl")`, then write the reformatted data to file. Tidy means there is one column giving the sex and another giving the mass

`r emo::ji("clapper")` Load the `tidyverse` `r Cite(myBib, "Wickham2019-ml")` and import:  
```{r eval=FALSE}
library(tidyverse)

# import
# data are the masses of male and female chaffinches organised
# as two columns, `males` and `females`
file <- "data-raw/chaff.txt"
chaff <- read_table(file)
```

`r emo::ji("loudspeaker")` **Note:** Your working directory is the Project directory, `chaffinches/`, not the location of the script, `R/`. When using a project, write your paths relative the project directory.


`r emo::ji("clapper")` Reformat as tidy: 
```{r eval=FALSE}
# reformat to tidy
chaff_tidy <- pivot_longer(chaff,
                           cols = everything(),
                           names_to = "sex",
                           values_to = "mass")
```

`r emo::ji("clapper")` Write to file: 
```{r eval=FALSE}
# write reformatted data to file
file <- "data-processed/chaff-tidy.txt"
write_delim(chaff_tidy, file)
```

We have now imported and reformatted the data and written the new format to write. The next steps are to summarise chaffinch mass by sex and significance test for a difference in mass between male and female chaffinches.


`r emo::ji("clapper")` Make a script called `02-summarise.R` for summarising the data: 
```{r eval=FALSE, echo=FALSE}
usethis::use_r("02-summarise")
```

`r emo::ji("clapper")` Summarise chaffinch mass by sex with:
```{r eval=FALSE}
# means, standard deviations, standard errors and sample sizes
chaff_summary <- chaff_tidy %>%
  group_by(sex) %>%
  summarise(mean = mean(mass),
            std = sd(mass),
            n = length(mass),
            se = std/sqrt(n))
```

`r emo::ji("look")` The pipe operator, ` %>%`, may be new to you. We will be covering it in more detail next week. You can read the pipe as 'and then'. For example: 
<pre>
chaff_tidy %>%                  # take `chaff_tidy` *and then*
  group_by(sex) %>%             # group it by `sex` *and then*
  summarise(mean = mean(mass),  # summarise it by calculating: the mean,
            std = sd(mass),     #                              the standard deviation
            n = length(mass),   #                              the sample size
            se = std/sqrt(n))   #                              the standard error

</pre>


`r emo::ji("clapper")` Conduct an appropriate statistical test to determine whether male and female chaffinches differ in mass. You may want to look this up in these [BIO00017C lecture notes](https://www-users.york.ac.uk/~er13/17C%20-%202018/lects/web06Two%20sample%20tests.pdf). Think about your code organisation.

```{r eval=FALSE, echo=FALSE}
usethis::use_r("03-test")
```

```{r eval=FALSE, echo=FALSE}
t.test(data = chaff_tidy,
       mass ~ sex,
       paired = F,
       var.equal = T)
```

Now we will create a figure and write it to file using `ggsave()`.

`r emo::ji("clapper")` Create a report-worthy figure using **`ggplot2`** for the analysis. Think about your code organisation.

```{r eval=FALSE, echo=FALSE}
usethis::use_r("04-figure")
```


```{r eval=FALSE, echo=FALSE}
fig1 <- ggplot() +
  geom_point(data = chaff_tidy, aes(x = sex, y = mass),
             position = position_jitter(width = 0.1, height = 0),
             colour = "gray50") +
  geom_errorbar(data = chaff_summary,
                aes(x = sex, ymin = mean - se, ymax = mean + se),
                width = 0.3) +
  geom_errorbar(data = chaff_summary,
                aes(x = sex, ymin = mean, ymax = mean),
                width = 0.2) +
  scale_y_continuous(name = "Mass (g)",
                     limits = c(0, 30),
                     expand = c(0, 0)) +
  scale_x_discrete(name = "",
                   labels = c("Females", "Males")) +
  annotate("segment", x = 1, xend = 2,     # long horizontal.
           y = 28, yend = 28,
           colour = "black") +
  annotate("segment", x = 2, xend = 2,     # short vertical
           y = 28, yend = 27,
           colour = "black") +
  annotate("segment", x = 1, xend = 1,     # short vertical
           y = 28, yend = 27,
           colour = "black") +
  annotate("text", x = 1.5,  y = 29,       # the text
           label = expression(italic(p)~"= 0.01175")) +
  theme_classic()
```


`r emo::ji("clapper")` Write the figure to file to file. A useful function for saving **`ggplot2`** figures is [`ggsave()`](https://ggplot2.tidyverse.org/reference/ggsave.html). It has arguments for the size, resolution and device for the image. Since I often make more than one figure, I might set these argument values to variables first:

```{r eval=FALSE}
# figure saving settings
units <- "in"     # inches. "cm", "mm", "px" also possible
fig_w <- 3.5
fig_h <- fig_w
dpi <- 300
device <- "png"   # Options are: eps", "ps", "tex", "pdf", "jpeg", 
                  # "tiff", "png", "bmp", "svg" or "wmf" (windows only).
```
Then write the figure to file using, for example:

```{r eval=FALSE}
ggsave("figures/fig1.png",
       plot = fig1,
       device = device,
       width = fig_w,
       height = fig_h,
       units = units,
       dpi = dpi)
```

`r emo::ji("clapper")` Reconsider the organisation of your code and project.

-  Are the names of R objects, files and directories informative and systematic?
-  Have you scripted everything?
-  Is your code well commented? 
-  Is code in logical places?
-  See chapters 1 and 2 of [The tidyverse style guide](https://style.tidyverse.org/) for more suggestions.  

`r emo::ji("clapper")` Have a look at my version of [chaffinches](https://github.com/3mmaRand/chaffinches)
# The Rmd file

[Rmd file](01_project_organisation.Rmd)


Pages made with `rmarkdown` `r Cite(myBib, c("markdown1","markdown2", "markdown3"))`, `RefManageR``r Cite(myBib, "RefManageR")` 


# References 

```{r refs, echo=FALSE, results="asis"}
PrintBibliography(myBib)  
```

# Please cite as:

Emma Rand. (2021). Data Science strand of BIO00058M (v1.0). Zenodo. https://doi.org/10.5281/zenodo.5442490

![](../pics/58Mend.png)


